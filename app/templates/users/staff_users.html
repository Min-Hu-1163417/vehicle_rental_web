{% extends "layouts/base.html" %}
{% block content %}
<h3>Manage Users</h3>

<p class="text-muted">
    <strong>Note:</strong> Staff accounts cannot be created here. They are provisioned out-of-band (seeded staff only).
    Use <code>staff/Staff123</code> after running <code>python seeds.py</code>.
</p>

<form id="createUserForm" class="row g-2 mb-3" method="post" action="/staff/users/add" novalidate>
    <!-- Username -->
    <div class="col-md-3">
        <input
                id="username"
                class="form-control"
                name="username"
                placeholder="username (3–10 chars, letters, digits, . _ -)"
                pattern="^[A-Za-z0-9_.-]{3,10}$"
                aria-describedby="usernameHint"
                required
        />
        <small id="usernameHint" class="text-danger d-none">
            Username must be 3–10 characters (letters, digits, '.', '_', or '-').
        </small>
    </div>

    <!-- Role -->
    <div class="col-md-3">
        <select id="role" class="form-select" name="role" required>
            <option value="">Select role</option>
            <option value="individual">individual</option>
            <option value="corporate">corporate</option>
        </select>
    </div>

    <!-- Password -->
    <div class="col-md-3 position-relative">
        <input
                id="password"
                type="password"
                class="form-control pe-5"
                name="password"
                placeholder="password (6+ chars, A-Z, a-z, 0-9)"
                pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$"
                aria-describedby="pwHint"
                required
        />
        <i id="togglePassword" class="bi bi-eye position-absolute"
           style="right: 12px; top: 9px; cursor: pointer; color: #6c757d;"></i>
        <small id="pwHint" class="text-danger d-none">
            Password must have at least 6 characters, including A-Z, a-z, and 0-9.
        </small>
    </div>

    <!-- Submit -->
    <div class="col-md-3">
        <button id="createBtn" class="btn btn-primary w-100" type="submit" disabled>Create</button>
    </div>
</form>

<table class="table table-striped">
    <thead>
    <tr>
        <th>renter_id</th>
        <th>username</th>
        <th>role</th>
        <th></th>
    </tr>
    </thead>
    <tbody>
    {% for u in users %}
    <tr>
        <td>{{ u.renter_id }}</td>
        <td>{{ u.username }}</td>
        <td>{{ u.role }}</td>
        <td>
            {% if u.username != 'admin' and u.role != 'staff' %}
            <form method="post" action="/staff/users/delete" class="d-inline">
                <input type="hidden" name="renter_id" value="{{ u.renter_id }}"/>
                <button class="btn btn-sm btn-outline-danger"
                        onclick='return confirm({{ ("Are you sure you want to delete user " ~ u.username ~ "? This action cannot be undone.")|tojson }});'>
                    Delete
                </button>
            </form>
            {% else %}
            <span class="text-muted small">protected</span>
            {% endif %}
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

<script>
	(function () {
		const username = document.getElementById("username");
		const role = document.getElementById("role");
		const password = document.getElementById("password");
		const usernameHint = document.getElementById("usernameHint");
		const pwHint = document.getElementById("pwHint");
		const createBtn = document.getElementById("createBtn");
		const toggle = document.getElementById("togglePassword");

		// Shared regex (same as backend)
		const USERNAME_PATTERN = /^[A-Za-z0-9_.-]{3,10}$/;
		const PASSWORD_PATTERN = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d).{6,}$/;

		// Toggle password visibility
		toggle.addEventListener("click", () => {
			const show = password.type === "password";
			password.type = show ? "text" : "password";
			toggle.className = show
				? "bi bi-eye-slash position-absolute"
				: "bi bi-eye position-absolute";
			toggle.style.color = show ? "#000" : "#6c757d";
		});

		function checkForm() {
			const u = username.value;
			const r = role.value;
			const p = password.value;

			const validUsername = USERNAME_PATTERN.test(u.trim());
			const validRole = r.trim() !== "";
			const validPassword = PASSWORD_PATTERN.test(p);

			// Show/hide hints
			usernameHint.classList.toggle("d-none", validUsername || u.trim() === "");
			pwHint.classList.toggle("d-none", validPassword || p === "");

			// Enable button only if all are valid
			createBtn.disabled = !(validUsername && validRole && validPassword);
		}

		// Live validation
		[username, role, password].forEach(el => {
			el.addEventListener("input", checkForm);
			el.addEventListener("change", checkForm);
		});

		checkForm();
	})();
</script>

<!-- Bootstrap Icons -->
<link rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css">
{% endblock %}
