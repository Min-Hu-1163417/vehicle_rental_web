{% extends "layouts/base.html" %}
{% block content %}
<h3>Manage Vehicles</h3>

<!-- Add vehicle form -->
<form id="addVehicleForm" class="row g-2 mb-3" method="post" action="/staff/vehicles/add">
    <div class="col-md-2">
        <input id="brand" class="form-control" name="brand" placeholder="brand" required>
    </div>

    <div class="col-md-2">
        <input id="model" class="form-control" name="model" placeholder="model" required>
    </div>

    <div class="col-md-2">
        <select id="type" class="form-select" name="type" required>
            <option value="">Select type</option>
            <option value="car">car</option>
            <option value="motorbike">motorbike</option>
            <option value="truck">truck</option>
        </select>
    </div>

    <div class="col-md-2">
        <input id="rate" class="form-control" name="rate" type="number" step="1" min="0"
               placeholder="rate/day" required>
    </div>

    <div class="col-md-3">
        <input id="image_path" class="form-control" name="image_path" placeholder="http/https or /static/...">
    </div>

    <div class="col-md-1">
        <button id="addBtn" class="btn btn-primary w-100" type="submit" disabled>Add</button>
    </div>
</form>

<!-- Vehicle list -->
{% if vehicles %}
<table class="table table-striped align-middle">
    <thead class="table-light">
    <tr>
        <th></th>
        <th>ID</th>
        <th>Brand</th>
        <th>Model</th>
        <th>Type</th>
        <th>Rate/day</th>
        <th>Status</th>
        <th class="text-end">Actions</th>
    </tr>
    </thead>
    <tbody>
    {% for v in vehicles %}
    {% set status = v.status | default('available', true) %}
    <tr>
        <td>
            <a href="/vehicles/{{ v.vehicle_id }}">
                <img
                        src="{{ v.image_path or url_for('static', filename='images/placeholder-vehicle.svg') }}"
                        referrerpolicy="no-referrer"
                        alt="thumbnail"
                        style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 8px;"
                        onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/placeholder-vehicle.svg') }}';"
                >
            </a>
        </td>

        <td>
            <span class="vehicle-id" onclick="copyToClipboard('{{ v.vehicle_id }}', this)">
                {{ v.vehicle_id }}
            </span>
        </td>
        <td>{{ v.brand }}</td>
        <td>{{ v.model }}</td>
        <td>{{ v.type }}</td>
        <td>${{ '%.2f'|format(v.rate) }}</td>

        <td>
        <span class="badge
            {% if status == 'rented' %} bg-primary
            {% elif status == 'overdue' %} bg-danger
            {% elif status in ['returned', 'available'] %} bg-success
            {% elif status == 'cancelled' %} bg-secondary
            {% else %} bg-light text-dark
            {% endif %}">
            {{ status }}
        </span>
        </td>

        <td class="text-end">
            <!-- âœ… Edit button -->
            <button class="btn btn-sm btn-outline-secondary me-1"
                    onclick="openEditModal('{{ v.vehicle_id }}', '{{ v.brand }}', '{{ v.model }}', '{{ v.type }}', '{{ v.rate }}', '{{ v.image_path }}')">
                Edit
            </button>

            <form method="post" action="/staff/vehicles/delete" class="d-inline"
                  onsubmit="return confirm('Delete this vehicle?');">
                <input type="hidden" name="vehicle_id" value="{{ v.vehicle_id }}">
                <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>
</table>

{% else %}
<!-- Empty state -->
<div class="col-12 d-flex justify-content-center align-items-center py-5">
    <div class="card shadow-sm border-0 text-center p-5" style="max-width: 540px;">
        <div class="display-4 mb-3">ðŸš—</div>
        <h4 class="mb-2">No vehicles found</h4>
        {% if has_filters %}
        <p class="text-muted mb-4">
            No vehicles match your current filters. Try adjusting your search criteria.
        </p>
        <a href="{{ request.path }}" class="btn btn-outline-primary">Reset filters</a>
        {% else %}
        <p class="text-muted mb-4">
            There are currently no vehicles available.
        </p>
        <a href="{{ url_for('views.home') }}" class="btn btn-outline-secondary">Back to home</a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- âœ… Edit Vehicle Modal -->
<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="editForm" method="post" action="/staff/vehicles/edit">
                <div class="modal-header">
                    <h5 class="modal-title">Edit Vehicle</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" name="vehicle_id" id="editVehicleId">

                    <div class="mb-3">
                        <label class="form-label">Brand</label>
                        <input type="text" class="form-control" id="editBrand" name="brand" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Model</label>
                        <input type="text" class="form-control" id="editModel" name="model" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Type</label>
                        <select class="form-select" id="editType" name="type" required>
                            <option value="car">car</option>
                            <option value="motorbike">motorbike</option>
                            <option value="truck">truck</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Rate/day</label>
                        <input type="number" class="form-control" id="editRate" name="rate" min="0" step="1" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Image URL</label>
                        <input type="text" class="form-control" id="editImagePath" name="image_path">
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save changes</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Styles -->
<style>
    a img {
        cursor: pointer;
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    a img:hover {
        transform: scale(1.05);
        box-shadow: 0 0 6px rgba(13, 110, 253, 0.4);
    }

    .vehicle-id {
        cursor: pointer;
        color: #000;
        font-family: monospace;
        transition: color 0.2s ease;
    }

    .vehicle-id:hover {
        color: #0d6efd;
    }
</style>

<!-- JS -->
<script>
	function copyToClipboard(text, el) {
		const ta = document.createElement("textarea");
		ta.value = text;
		document.body.appendChild(ta);
		ta.select();
		document.execCommand("copy");
		document.body.removeChild(ta);

		const original = el.textContent;
		el.textContent = "Copied!";
		el.style.color = "#198754";
		setTimeout(() => {
			el.textContent = original;
			el.style.color = "";
		}, 1200);
	}

	window.openEditModal = function (id, brand, model, type, rate, imagePath) {
		document.getElementById("editVehicleId").value = id;
		document.getElementById("editBrand").value = brand;
		document.getElementById("editModel").value = model;
		document.getElementById("editType").value = type;
		document.getElementById("editRate").value = rate;
		document.getElementById("editImagePath").value = imagePath;

		const modal = new bootstrap.Modal(document.getElementById("editModal"));
		modal.show();
	};

	(function () {
		const brand = document.getElementById("brand");
		const model = document.getElementById("model");
		const type = document.getElementById("type");
		const rate = document.getElementById("rate");
		const addBtn = document.getElementById("addBtn");

		function checkForm() {
			const validBrand = brand.value.trim() !== "";
			const validModel = model.value.trim() !== "";
			const validType = type.value.trim() !== "";
			const validRate = rate.value.trim() !== "" && Number(rate.value) > 0;
			addBtn.disabled = !(validBrand && validModel && validType && validRate);
		}

		[brand, model, type, rate].forEach(el => {
			el.addEventListener("input", checkForm);
			el.addEventListener("change", checkForm);
		});
		checkForm();
	})();
</script>
{% endblock %}
