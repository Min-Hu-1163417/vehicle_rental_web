{% extends "layouts/base.html" %}
{% block content %}
<h3>Manage Vehicles</h3>

<!-- Add vehicle form -->
<form id="addVehicleForm" class="row g-2 mb-3" method="post" action="/staff/vehicles/add">
    <div class="col-md-2">
        <input id="brand" class="form-control" name="brand" placeholder="brand" required>
    </div>

    <div class="col-md-2">
        <input id="model" class="form-control" name="model" placeholder="model" required>
    </div>

    <div class="col-md-2">
        <select id="type" class="form-select" name="type" required>
            <option value="">Select type</option>
            <option value="car">car</option>
            <option value="motorbike">motorbike</option>
            <option value="truck">truck</option>
        </select>
    </div>

    <div class="col-md-2">
        <input id="rate" class="form-control" name="rate" type="number" step="5" min="0"
               placeholder="rate/day" required>
    </div>

    <div class="col-md-3">
        <input id="image_path" class="form-control" name="image_path" placeholder="http/https or /static/...">
    </div>

    <div class="col-md-1">
        <button id="addBtn" class="btn btn-primary w-100" type="submit" disabled>Add</button>
    </div>
</form>

<!-- Vehicle list -->
{% if vehicles %}
<table class="table table-striped align-middle">
    <thead class="table-light">
    <tr>
        <th></th>
        <th>ID</th>
        <th>Brand</th>
        <th>Model</th>
        <th>Type</th>
        <th>Rate/day</th>
        <th>Status</th>
        <th></th>
    </tr>
    </thead>
    <tbody>
    {% for v in vehicles %}
    {% set status = v.status | default('available', true) %}
    <tr>
        <td>
            <a href="/vehicles/{{ v.vehicle_id }}">
                <img
                        src="{{ v.image_path or url_for('static', filename='images/placeholder-vehicle.svg') }}"
                        referrerpolicy="no-referrer"
                        alt="thumbnail"
                        style="width: 60px; height: 40px; object-fit: cover; border-radius: 4px; margin-right: 8px;"
                        onerror="this.onerror=null;this.src='{{ url_for('static', filename='images/placeholder-vehicle.svg') }}';"
                >
            </a>
        </td>

        <td>
            <span class="vehicle-id" onclick="copyToClipboard('{{ v.vehicle_id }}', this)">
                {{ v.vehicle_id }}
            </span>
        </td>
        <td>{{ v.brand }}</td>
        <td>{{ v.model }}</td>
        <td>{{ v.type }}</td>
        <td>${{ '%.2f'|format(v.rate) }}</td>

        <td>
        <span class="badge
            {% if status == 'rented' %} bg-primary
            {% elif status == 'overdue' %} bg-danger
            {% elif status in ['returned', 'available'] %} bg-success
            {% elif status == 'cancelled' %} bg-secondary
            {% else %} bg-light text-dark
            {% endif %}">
            {{ status }}
        </span>
            {% if status == 'overdue' and v.overdue_days %}
            <small class="text-danger ms-1">
                ({{ v.overdue_days }} day{{ 's' if v.overdue_days|int != 1 }})
            </small>
            {% endif %}
        </td>

        <td>
            <form method="post" action="/staff/vehicles/delete" onsubmit="return confirm('Delete this vehicle?');">
                <input type="hidden" name="vehicle_id" value="{{ v.vehicle_id }}">
                <button class="btn btn-sm btn-outline-danger">Delete</button>
            </form>
        </td>
    </tr>
    {% endfor %}
    </tbody>

</table>

{% else %}
<!-- Empty state -->
<div class="col-12 d-flex justify-content-center align-items-center py-5">
    <div class="card shadow-sm border-0 text-center p-5" style="max-width: 540px;">
        <div class="display-4 mb-3">ðŸš—</div>
        <h4 class="mb-2">No vehicles found</h4>
        {% if has_filters %}
        <p class="text-muted mb-4">
            No vehicles match your current filters. Try adjusting your search criteria.
        </p>
        <a href="{{ request.path }}" class="btn btn-outline-primary">Reset filters</a>
        {% else %}
        <p class="text-muted mb-4">
            There are currently no vehicles available.
        </p>
        <a href="{{ url_for('views.home') }}" class="btn btn-outline-secondary">Back to home</a>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Styles -->
<style>
    .vehicle-id {
        cursor: pointer;
        color: #000;
        font-family: monospace;
        transition: color 0.2s ease;
    }

    .vehicle-id:hover {
        color: #0d6efd;
    }
</style>

<!-- JS -->
<script>
	(function () {
		const brand = document.getElementById("brand");
		const model = document.getElementById("model");
		const type = document.getElementById("type");
		const rate = document.getElementById("rate");
		const addBtn = document.getElementById("addBtn");

		function checkForm() {
			const validBrand = brand.value.trim() !== "";
			const validModel = model.value.trim() !== "";
			const validType = type.value.trim() !== "";
			const validRate = rate.value.trim() !== "" && Number(rate.value) > 0;

			// Enable Add button only if all required fields are valid
			addBtn.disabled = !(validBrand && validModel && validType && validRate);
		}

		[brand, model, type, rate].forEach(el => {
			el.addEventListener("input", checkForm);
			el.addEventListener("change", checkForm);
		});

		// Initialize state
		checkForm();
	})();
</script>
{% endblock %}
